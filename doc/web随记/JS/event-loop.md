# JSè¿è¡Œæœºåˆ¶åŠEvent Loop

> äº†è§£jsæ‰§è¡Œé¡ºåºåŠæœºåˆ¶ï¼Œæ›´å¥½çš„ç†è§£jsç‰¹æ€§ï¼Œç†é¡ºä»£ç ä¸­çš„ä¸€äº›å¼‚æ­¥æ“ä½œ ğŸš€

- JavaScriptæ˜¯å•çº¿ç¨‹çš„è¯­è¨€
- Event Loopæ˜¯javascriptçš„æ‰§è¡Œæœºåˆ¶
- synchronousï¼šåŒæ­¥ä»»åŠ¡ã€asynchronousï¼šå¼‚æ­¥ä»»åŠ¡ã€task queue/callback queueï¼šä»»åŠ¡é˜Ÿåˆ—ã€execution context stackï¼šæ‰§è¡Œæ ˆã€heapï¼šå †ã€stackï¼šæ ˆã€macro-taskï¼šå®ä»»åŠ¡ã€micro-taskï¼šå¾®ä»»åŠ¡

## èƒŒæ™¯

JS ä»è¯ç”Ÿèµ·å°±æ˜¯ä¸€é—¨å•çº¿ç¨‹çš„è¯­è¨€ã€‚è‡³äºä¸ºä»€ä¹ˆæ˜¯**å•çº¿ç¨‹**ï¼Œæ˜¯å› ä¸ºä½œè€…è®¤ä¸º JS æ˜¯åœ¨æµè§ˆå™¨æ‰§è¡Œçš„è„šæœ¬è¯­è¨€ï¼Œå¯¹å®ƒçš„è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œæ—©æœŸçš„ç½‘é¡µå¯¹ JS éœ€æ±‚æ²¡é‚£ä¹ˆé«˜ï¼Œéƒ½æ˜¯è½»é‡çº§çš„ã€‚è€Œä¸”å†™èµ·æ¥ä¸€å®šè¦ç®€å•ï¼Œè€Œå¤šçº¿ç¨‹é€»è¾‘ä¼šé€ æˆäº¤äº’ã€DOM æ“ä½œå¤æ‚ã€‚

**å•çº¿ç¨‹é—®é¢˜**ï¼Œä»»åŠ¡æ‰§è¡Œé˜»å¡ï¼Œå…·ç°åˆ°é¡µé¢ä¸Šï¼šajaxæ•°æ®è¯·æ±‚ï¼Œhttpå»¶è¿Ÿï¼Œç­‰å¾…å®Œæˆï¼Œå…¶ä»–æ“ä½œæ— æ³•æ‰§è¡Œï¼Œé¡µé¢é•¿æ—¶é—´æ— æ³•æ¥å—ååº”ã€‚åƒé¡µé¢æ“ä½œï¼ˆç‚¹å‡»ï¼‰çš„ä»£ç å°±æ— æ³•ç«‹å³æ‰§è¡Œï¼Œåªæ˜¯ WebAPIs æŠŠ callback æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œè€Œå·²ï¼Œç”¨æˆ·å°±ä¼šè®¤ä¸ºé¡µé¢å¡ä½äº†ï¼Œæ“ä½œæ— ååº”äº†ã€‚

å¦å¤–ï¼ŒUI æ¸²æŸ“å’Œ JS æ‰§è¡Œæ˜¯äº’æ–¥çš„ã€‚è™½ç„¶ä¸¤è€…å±äºä¸åŒçš„çº¿ç¨‹ï¼Œä½†æ˜¯ç”±äº JS æ‰§è¡Œç»“æœå¯èƒ½ä¼šå¯¹é¡µé¢äº§ç”Ÿå½±å“ï¼Œæ‰€ä»¥æµè§ˆå™¨å¯¹æ­¤åšäº†å¤„ç†ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ JS çº¿ç¨‹æ‰§è¡Œï¼Œrender çº¿ç¨‹å°±ä¼šæš‚åœï¼Œå½“ JS çš„åŒæ­¥ä»£ç æ‰§è¡Œå®Œå†å»æ¸²æŸ“ã€‚

æ‰€ä»¥ JS ç”¨**å¼‚æ­¥ä»»åŠ¡ (asynchronous callback)**å»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## é˜»å¡ã€å¼‚æ­¥

```js
fetch('url'); //å‡è®¾æ˜¯åŒæ­¥ fetchï¼Œé˜»å¡ä»£ç æ‰§è¡Œã€‚

render(); // é˜»å¡æƒ…å†µä¸‹æ— æ³•æ‰§è¡Œ
```

ä¸Šé¢æåˆ°çš„è¿™ç§æ‰§è¡Œæ¨¡å¼ç®—æ˜¯é˜»å¡æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯åœ¨ä»»åŠ¡è¿”å›ç»“æœä¹‹å‰ï¼ŒJS å¼•æ“çº¿ç¨‹ pending äº†ï¼Œå¯¼è‡´åé¢çš„ä»»åŠ¡é˜»å¡
å¯¹äºæµè§ˆå™¨è¿™ç§å®æ—¶æ€§ã€äº¤äº’æ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼Œè‚¯å®šæ˜¯ä¸å…è®¸çš„ã€‚æ‰€ä»¥é¦–å…ˆè¦**éé˜»å¡è°ƒç”¨**ã€‚éé˜»å¡è°ƒç”¨å°±æ˜¯æµè§ˆå™¨å‘é€çš„è¿™ä¸ªè¯·æ±‚ä»»åŠ¡ï¼Œä¸éœ€è¦ç­‰å¾…ç»“æœå°±ç«‹å³è¿”å›ï¼Œä½†æ˜¯å…·ä½“æ•°æ®å›æ²¡å›æ¥ï¼Œå°±éœ€è¦ JS çº¿ç¨‹**ä¸å®šæ—¶çš„æŸ¥çœ‹**äº†ã€‚è€Œæ›´å¥½çš„åšæ³•æ˜¯ï¼Œè¿™ä¸ªè¯·æ±‚ä»»åŠ¡å®Œæˆåï¼ˆå¾—åˆ°æ•°æ®ï¼‰ï¼Œé€šçŸ¥æˆ‘ä»¬ï¼Œè®©æˆ‘ä»¬å»è·å–æ•°æ®ã€‚è¿™å°±éœ€è¦ç”¨åˆ°**å¼‚æ­¥ I/O çš„æ¨¡å¼**ã€‚ä¸»çº¿ç¨‹æ‰§è¡Œé‡åˆ°å¼‚æ­¥ä»»åŠ¡ï¼ˆè¯·æ±‚ï¼‰ï¼Œä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œåªéœ€è¦ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œå³å»è¿è¡Œå…¶ä»–çš„ä»»åŠ¡ã€‚å½“å¼‚æ­¥ä»»åŠ¡å®Œæˆåï¼Œä¼šä»¥æŸç§æ–¹å¼â€œé€šçŸ¥â€ä¸»çº¿ç¨‹ï¼Œå‡å¦‚ä¸»çº¿ç¨‹å¤„äºé—²ç½®ï¼Œå°±ä¼šæ¥æ”¶å¼‚æ­¥ä»»åŠ¡çš„ç»“æœï¼Œäº¦æˆ–æ˜¯æ²¡æœ‰ç»“æœã€‚åœ¨ JS ä¸­ï¼Œå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œéƒ½æ˜¯ä»¥ **callback** çš„å½¢å¼ï¼Œè¿”å›ç»™ä¸»çº¿ç¨‹ç»“æœçš„ã€‚æ‰€ä»¥ï¼ŒJS æ˜¯è¿™ç§å¼‚æ­¥éé˜»å¡çš„æ–¹å¼ï¼Œå»æ»¡è¶³é¡µé¢å®æ—¶äº¤äº’çš„éœ€æ±‚ï¼Œé¿å…â€œé¡µé¢â€å‡æ­»çš„ã€‚

**æµè§ˆå™¨å°è¡¥å……**ï¼š

ç°ä»£æµè§ˆå™¨ä¸€ä¸ª tab çš„çº¿ç¨‹åŒ…æ‹¬ä¸å±€é™äºï¼š

- GUI æ¸²æŸ“çº¿ç¨‹
- JSå¼•æ“çº¿ç¨‹
- äº‹ä»¶è§¦å‘çº¿ç¨‹
- å®šæ—¶å™¨è§¦å‘çº¿ç¨‹
- å¼‚æ­¥httpè¯·æ±‚çº¿ç¨‹

JS ä¸­çš„å¼‚æ­¥æ“ä½œæ˜¯é€šè¿‡ WebAPIs å»æ”¯æŒçš„ï¼Œå¸¸è§çš„æœ‰ `XMLHttpRequest`ï¼Œ`setTimeout`ï¼Œäº‹ä»¶å›è°ƒï¼ˆ`onclik`, `onscroll`ç­‰ï¼‰ã€‚è€Œè¿™å‡ ä¸ª API æµè§ˆå™¨éƒ½æä¾›äº†å•ç‹¬çš„çº¿ç¨‹å»è¿è¡Œï¼Œæ‰€ä»¥æ‰ä¼šæœ‰åœ°æ–¹å»åšå®šæ—¶å™¨çš„è®¡æ—¶ï¼Œrequest çš„å›è°ƒã€‚

å³å½“ä»£ç ä¸­å‡ºç°è¿™å‡ ä¸ªå®šä¹‰çš„å¼‚æ­¥ä»»åŠ¡ï¼Œæ˜¯æµè§ˆå™¨æä¾›èƒ½åŠ›å»æ»¡è¶³éœ€æ±‚ï¼Œ**æ˜¯ä¸è·Ÿ JS å¼•æ“åŒå±ä¸€ä¸ªçº¿ç¨‹çš„ï¼Œæ˜¯æµè§ˆå™¨å®ç°äº†å®ƒä»¬è·Ÿ JS å¼•æ“çš„é€šä¿¡**ã€‚

## ä»»åŠ¡é˜Ÿåˆ—

ä¸Šé¢æåˆ°äº†å¼‚æ­¥ä»»åŠ¡å®Œæˆåï¼Œä¼šé€šçŸ¥ä¸»çº¿ç¨‹ï¼Œä»¥ callback çš„æ–¹å¼è·å–ç»“æœæˆ–è€…æ‰§è¡Œå›è°ƒã€‚ä½†æ˜¯å¦‚æœå½“å‰çš„ä¸»çº¿ç¨‹æ˜¯å¿™ç¢Œçš„ï¼Œå¼‚æ­¥ä»»åŠ¡çš„ä¿¡å·æ— æ³•æ¥æ”¶åˆ°æ€ä¹ˆåŠå‘¢ï¼Ÿ
æ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªåœ°æ–¹ä¿å­˜è¿™äº› callbackï¼Œä¹Ÿå°±æ˜¯**ä»»åŠ¡é˜Ÿåˆ—(task queue)**

>ğŸ”¥æè¿°ï¼šå°±æ˜¯ä¸»çº¿ç¨‹è¿è¡Œäº§ç”Ÿ**å †ã€æ ˆ**ï¼Œæ‰§è¡Œæ ˆé‡åˆ°å¼‚æ­¥ä»»åŠ¡ï¼ˆæµè§ˆå™¨é€šå¸¸æ˜¯è°ƒç”¨ WebAPIsï¼‰ï¼Œä¸ä¼šç­‰å¾…ï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œå¾€ä¸‹æ‰§è¡Œã€‚è€Œå¼‚æ­¥ä»»åŠ¡å°±ä¼šä»¥å„ç§æ–¹å¼ï¼ŒæŠŠ callback åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚å¾…å½“å‰æ‰§è¡Œæ ˆæ‰§è¡Œå®Œæ¯•ï¼Œä¹Ÿå°±æ˜¯å‡ºæ ˆå®Œæ¯•ï¼Œä¸»çº¿ç¨‹å°±ä¼šä»ä»»åŠ¡é˜Ÿåˆ—é‡Œè¯»å–ç¬¬ä¸€ä¸ª callbackï¼Œæ‰§è¡Œã€‚åŒæ ·çš„ç”Ÿæˆæ‰§è¡Œæ ˆï¼Œç»“æŸåä¸»çº¿ç¨‹å¦‚æœå‘ç°ä»»åŠ¡é˜Ÿåˆ—ä¸­è¿˜æœ‰ callbackï¼Œåˆ™ä¼šç»§ç»­å–å‡ºæ‰§è¡Œï¼Œå¦‚æ­¤é‡å¤æ“ä½œã€‚è€Œè¿™ç§å¾ªç¯çš„æœºåˆ¶ï¼Œå°±ç§°ä¹‹ä¸º**äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰**ã€‚

![Event-Loop](https://raw.githubusercontent.com/NARUTOne/resources-github/master/imgs/js/Event-Loop.png)

## Event Loop

> ä¸€ç§ç¡®ä¿äº†è¿™äº›å¼‚æ­¥ä»»åŠ¡çš„æœ‰åºæ‰§è¡Œçš„æœºåˆ¶

- heapï¼ˆå †ï¼‰æ˜¯ç”¨æˆ·ä¸»åŠ¨è¯·æ±‚è€Œåˆ’åˆ†å‡ºæ¥çš„å†…å­˜åŒºåŸŸï¼Œæ¯”å¦‚ä½ new Object()ï¼Œå°±æ˜¯å°†ä¸€ä¸ªå¯¹è±¡å­˜å…¥å †ä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºheapå­˜å¯¹è±¡ã€‚
- stackï¼ˆæ ˆï¼‰æ˜¯ç”±äºå‡½æ•°è¿è¡Œè€Œä¸´æ—¶å ç”¨çš„å†…å­˜åŒºåŸŸï¼Œå‡½æ•°éƒ½å­˜æ”¾åœ¨æ ˆé‡Œã€‚

```js
setTimeout(() => {
  console.log(1);
}, 1000);

setTimeout(() => {
  console.log(2);
}, 0); // å…ˆè¿› task queueï¼Œç­‰å¾…å‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆï¼ˆå•çº¿ç¨‹ï¼‰ï¼Œç«‹å³æ‰§è¡Œï¼Œä¸éœ€è¦è¯»ç§’åå†æ”¾å…¥event queue

console.log(3);

for (let i = 0; i < 10000; i++) {
  console.log(1);
}

setTimeout(() => {
  console.log(4);
}, 100); // æœ€åæ”¾å…¥task queue
// 3, 10000 * 1, 2, 1, 4
```

æœ‰æ—¶delayæ—¶é—´å¹¶ä¸å‡†ç¡®

```js
setTimeout(() => {
  console.log(1);
  setTimeout(() => {
    console.log(2);
  }, 99);
}, 100);

setTimeout(() => {
  console.log(3);
}, 200);

console.log(4);
```

> ç»“æœå°±ä¸ç¡®å®šäº†ï¼Œå–å†³äºåŒæ­¥ä»£ç çš„è®¡ç®—æ—¶é—´ï¼Œæ‰€ä»¥å®šæ—¶å™¨è¿™ä¸ªä¸œè¥¿è¿˜æ˜¯æ¯”è¾ƒå‘çš„ï¼Œdelay å¹¶ä¸å‡†ç¡®ï¼Œå–å†³äºä½ çš„ JS çº¿ç¨‹æ˜¯å¦é—²ç½®ä»¥åŠæ‰§è¡Œæ•ˆç‡ã€‚

## å®ä»»åŠ¡/å¾®ä»»åŠ¡

> âŒ›jså¼‚æ­¥æœ‰ä¸€ä¸ªæœºåˆ¶ï¼Œå°±æ˜¯é‡åˆ°å®ä»»åŠ¡ï¼Œå…ˆæ‰§è¡Œå®ä»»åŠ¡ï¼Œå°†å®ä»»åŠ¡æ”¾å…¥eventqueueï¼Œç„¶ååœ¨æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œå°†å¾®ä»»åŠ¡æ”¾å…¥eventqueueæœ€éªšçš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªqueueä¸æ˜¯ä¸€ä¸ªqueueã€‚å½“ä½ å¾€å¤–æ‹¿çš„æ—¶å€™å…ˆä»å¾®ä»»åŠ¡é‡Œæ‹¿è¿™ä¸ªå›æ‰å‡½æ•°ï¼Œç„¶åå†ä»å®ä»»åŠ¡çš„queueä¸Šæ‹¿å®ä»»åŠ¡çš„å›æ‰å‡½æ•°ğŸ”¥

- å®ä»»åŠ¡ä¸€èˆ¬æ˜¯ï¼šåŒ…æ‹¬æ•´ä½“ä»£ç scriptï¼ŒsetTimeoutï¼ŒsetIntervalã€setImmediateã€‚
- å¾®ä»»åŠ¡ï¼šåŸç”ŸPromise(æœ‰äº›å®ç°çš„promiseå°†thenæ–¹æ³•æ”¾åˆ°äº†å®ä»»åŠ¡ä¸­)ã€process.nextTickã€Object.observe(å·²åºŸå¼ƒ)ã€ MutationObserverè®°ä½å°±è¡Œäº†ã€‚

```js
// 1. åŠ å…¥ tasks é˜Ÿåˆ—
setTimeout(()=>{
  // 7. é¦–æ¬¡ eventloop ç»“æŸï¼Œä» tasks ä¸­å–å‡º setTimeout callbackï¼Œæ‰§è¡Œã€‚
  console.log('timer');
  // 8. åŠ å…¥ microtask ä¸­
  Promise.resolve().then(function() {
    console.log('promise1')
  })
  // 9. task æ‰§è¡Œå®Œï¼Œæ¸…ç©º micro é˜Ÿåˆ—ï¼Œè¾“å‡º 'promise1'
}, 0);

// 2. åŠ å…¥ microtask é˜Ÿåˆ—
Promise.resolve().then(function() {// 5. ç¬¬ä¸€ä¸ª microtask ä»»åŠ¡
  console.log('promise2');
  // 6. æŠŠ promise3 åŠ å…¥ micro é˜Ÿåˆ—ï¼Œå‘ç°é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œæ‰§è¡Œè¾“å‡º 'promise3'
  Promise.resolve().then(function() {
    console.log('promise3');
  })
})

// 3. æ‰§è¡Œï¼Œè¾“å‡º 'script'
console.log('script');
// 4. ç¬¬ä¸€ä¸ª eventloop task é˜¶æ®µå®Œæ¯•, å¼€å§‹æ‰§è¡Œ microtask queue

// result: script, promise2, promise3, timer, promise1
```

```js
Promise.resolve().then(()=>{
  console.log('Promise1')  // 3ã€å…ˆæ‰§è¡Œå¾®ä»»åŠ¡ï¼Œæ¸…ç©ºmicro-task
  setTimeout(()=>{ // 4ã€å®ä»»åŠ¡ callback æ”¾å…¥ event queue
    console.log('setTimeout2') // 9æ‰§è¡Œ
  },0)
})

setTimeout(()=>{ // 2 å®ä»»åŠ¡ callback æ”¾å…¥ event queue
  console.log('setTimeout1') // 5ã€æ‰§è¡Œcallback
  new Promise((resolve) => {
    console.log('promise start'); // 6ã€æ‰§è¡ŒåŒæ­¥ä»»åŠ¡
    resolve();
  }).then(()=>{// 7ã€å¾®ä»»åŠ¡
    console.log('Promise2') ///8ã€æ‰§è¡Œå¾®ä»»åŠ¡
  })
},0)

console.log('start'); // 1ã€åŒæ­¥ä»»åŠ¡

```

## Node

> Nodeç¯å¢ƒä¸‹å¼‚æ­¥æ‰§è¡Œé¡ºåºä¸æµè§ˆå™¨ä¸‹jsæ‰§è¡Œé¡ºåºä¸å®Œå…¨ä¸€è‡´

nodeæ–°åŠ äº†ä¸€ä¸ªå¾®ä»»åŠ¡(process.nextTick)å’Œä¸€ä¸ªå®ä»»åŠ¡(setImmediate)

ç®€å•çš„æ¥è¯´ï¼Œå°±æ˜¯**nodeåœ¨å¤„ç†ä¸€ä¸ªæ‰§è¡Œé˜Ÿåˆ—çš„æ—¶å€™ä¸ç®¡æ€æ ·éƒ½ä¼šå…ˆæ‰§è¡Œå®Œå½“å‰é˜Ÿåˆ—ï¼Œç„¶åå†æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå†å»æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—**ã€‚

```js
console.log('start');
setTimeout(function() {
  console.log(2);
  new Promise((resolve) => {
    console.log('promise');
    resolve();
  }).then(() => {
    console.log('promise then');
  })
});

setTimeout(() => {
  console.log(3);
})

console.log('end');

// node: start, end, 2, promise, 3, promise then
// æµè§ˆå™¨js: start, end, 2, promise, promise then, 3
```

> ğŸ”¥ å¾®ä»»åŠ¡ä¸­process.nextTickæ¯”promise.thenå¿«

## é¢è¯•

```js
console.log('1');

setTimeout(function() {
    console.log('2');
    process.nextTick(function() {
        console.log('3');
    })
    new Promise(function(resolve) {
        console.log('4');
        resolve();
    }).then(function() {
        console.log('5')
    })
})
process.nextTick(function() {
    console.log('6');
})
new Promise(function(resolve) {
    console.log('7');
    resolve();
}).then(function() {
    console.log('8')
})

setTimeout(function() {
    console.log('9');
    process.nextTick(function() {
        console.log('10');
    })
    new Promise(function(resolve) {
        console.log('11');
        resolve();
    }).then(function() {
        console.log('12')
    })
})

// 1ï¼Œ7ï¼Œ6ï¼Œ8ï¼Œ2ï¼Œ4ï¼Œ3ï¼Œ5ï¼Œ9ï¼Œ11ï¼Œ10ï¼Œ12
// nodeç¯å¢ƒä¸‹çš„äº‹ä»¶ç›‘å¬ä¾èµ–libuvé©±åŠ¨I/Oåº“ä¸å‰ç«¯ç¯å¢ƒä¸å®Œå…¨ç›¸åŒï¼Œè¾“å‡ºé¡ºåºå¯èƒ½ä¼šæœ‰è¯¯å·®
```

## å‚è€ƒ

- [https://juejin.im/post/5b498d245188251b193d4059](https://juejin.im/post/5b498d245188251b193d4059)
- [https://juejin.im/post/5ac715b8f265da23986780fe](https://juejin.im/post/5ac715b8f265da23986780fe)
- [https://github.com/sunyongjian/blog/issues/38](https://github.com/sunyongjian/blog/issues/38)
